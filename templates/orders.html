<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kitchen Display System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }
        .header {
            background-color: #ffffff;
            color: #000000;
            padding: 5px 20px; /* Reduced padding to make the header smaller */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .buttons {
            display: flex;
            gap: 10px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
        }
        .order {
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin: 10px;
            padding: 15px;
            width: 250px;
            transition: transform 0.2s;
        }
        .order:hover {
            transform: scale(1.05);
        }
        .order.completed {
            background-color: #e0ffe0;
        }
        .line-item {
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        .line-item.completed {
            text-decoration: line-through;
            color: #888;
        }
        .modification {
            padding-left: 20px;
            font-style: italic;
            color: #555;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .completed {
            color: green;
        }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>Kitchen Display System</h1>
        <div class="buttons">
            <button onclick="completeAllOrders()">Complete All Orders</button>
            <button onclick="toggleCompletedOrders()">Show Completed Orders</button>
        </div>
    </div>
    <div class="container" id="orders-container">
        <!-- Orders will be dynamically inserted here -->
    </div>
    <script>
        const socket = io();
        const completedOrderItems = {};
        let showCompleted = true;

        socket.on('update_completed_orders', data => {
        const { order_id, item_id, completed } = data;
        const orderDiv = document.getElementById(`order-${order_id}`);
        if (orderDiv) {
            const itemDiv = orderDiv.querySelector(`.line-item[onclick*="'${item_id}'"]`);
            if (itemDiv) {
                if (completed) {
                    itemDiv.classList.add('completed');
                    completedOrderItems[order_id].add(item_id);
                } else {
                    itemDiv.classList.remove('completed');
                    completedOrderItems[order_id].delete(item_id);
                }
                checkOrderCompletion(order_id);
            }
        }
    });

        function fetchOrders() {
        fetch('/api/orders')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('orders-container');
                container.innerHTML = '';
                data.elements.forEach(order => {
                    if (!completedOrderItems[order.id]) {
                        completedOrderItems[order.id] = new Set();
                    }

                    const orderDiv = document.createElement('div');
                    orderDiv.className = `order ${Array.from(order.line_items.elements).every(item => completedOrderItems[order.id].has(item.id)) ? 'completed' : ''}`;
                    orderDiv.id = `order-${order.id}`;
                    orderDiv.dataset.createdTime = order.createdTime;

                    const incompleteItems = [];
                    const completedItems = [];

                    order.line_items.elements.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `line-item ${completedOrderItems[order.id].has(item.id) ? 'completed' : ''}`;
                        itemDiv.setAttribute('onclick', `markItemCompleted(this, '${order.id}', '${item.id}')`);
                        itemDiv.innerHTML = `<p>${item.name}</p>`;

                        if (item.modifications && item.modifications.elements) {
                            item.modifications.elements.forEach(mod => {
                                const modDiv = document.createElement('div');
                                modDiv.className = 'modification';
                                modDiv.innerHTML = `<p>${mod.name}</p>`;
                                itemDiv.appendChild(modDiv);
                            });
                        }

                        if (completedOrderItems[order.id].has(item.id)) {
                            completedItems.push(itemDiv);
                        } else {
                            incompleteItems.push(itemDiv);
                        }
                    });

                    const isOrderCompleted = order.line_items.elements.every(item => completedOrderItems[order.id].has(item.id));
                    const createdTimeText = isOrderCompleted ? 'Completed' : getElapsedTime(order.createdTime);

                    orderDiv.innerHTML = `
                        <h2>Order ID: ${order.id}</h2>
                        <p class="created-time">Created: ${createdTimeText}</p>
                        <strong>${order.title === undefined || order.title === null ? "Delivery" : order.title}</strong><br>
                        <p>Status: ${order.state === "locked" || order.state === null ? "Paid" : order.state}</p>
                        <p>Total: $${(order.total / 100.0).toFixed(2)}</p>
                        <h3>Items:</h3>
                        <div class="items-container">
                            ${incompleteItems.concat(completedItems).map(itemDiv => itemDiv.outerHTML).join('')}
                        </div>
                    `;

                    container.appendChild(orderDiv);
                });
                applyShowCompletedState(); // Apply the current state of showCompleted
            });
    }

        function updateOrderDiv(orderDiv, order) {
            const completedItems = [];
            const incompleteItems = [];

            order.line_items.elements.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `line-item ${completedOrderItems[order.id].has(item.id) ? 'completed' : ''}`;
                itemDiv.setAttribute('onclick', `markItemCompleted(this, '${order.id}', '${item.id}')`);
                itemDiv.innerHTML = `<p>${item.name}</p>`;

                if (item.modifications && item.modifications.elements) {
                    item.modifications.elements.forEach(mod => {
                        const modDiv = document.createElement('div');
                        modDiv.className = 'modification';
                        modDiv.innerHTML = `<p>${mod.name}</p>`;
                        itemDiv.appendChild(modDiv);
                    });
                }

                if (completedOrderItems[order.id].has(item.id)) {
                    completedItems.push(itemDiv);
                } else {
                    incompleteItems.push(itemDiv);
                }
            });

            const isOrderCompleted = order.line_items.elements.every(item => completedOrderItems[order.id].has(item.id));
            const createdTimeText = isOrderCompleted ? 'Completed' : getElapsedTime(order.createdTime);

            orderDiv.innerHTML = `
                <h2>Order ID: ${order.id}</h2>
                <p class="created-time">Created: ${createdTimeText}</p>
                <strong>${order.title === undefined || order.title === null ? "Delivery" : order.title}</strong><br>
                <p>Status: ${order.state === "locked" || order.state === null ? "Paid" : order.state}</p>
                <p>Total: $${(order.total / 100.0).toFixed(2)}</p>
                <h3>Items:</h3>
                <div class="items-container">
                    ${incompleteItems.concat(completedItems).map(itemDiv => itemDiv.outerHTML).join('')}
                </div>
            `;
        }

        function getElapsedTime(createdTime) {
            const now = new Date().getTime();
            const elapsed = now - createdTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function markItemCompleted(item, orderId, itemId) {
            item.classList.toggle('completed');
            const orderDiv = document.getElementById(`order-${orderId}`);
            const itemsContainer = orderDiv.querySelector('.items-container');

            const completed = item.classList.contains('completed');
            if (completed) {
                completedOrderItems[orderId].add(itemId);
                itemsContainer.appendChild(item); // Move to the bottom
            } else {
                completedOrderItems[orderId].delete(itemId);
                itemsContainer.insertBefore(item, itemsContainer.firstChild); // Move to the top
            }
            checkOrderCompletion(orderId);

            // Update server with the new state
            fetch('/api/completed_orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ order_id: orderId, item_id: itemId, completed: completed })
            }).catch(error => console.error('Error updating completed order:', error));
        }

        function checkOrderCompletion(orderId) {
        const orderDiv = document.getElementById(`order-${orderId}`);
        const items = orderDiv.querySelectorAll('.line-item');
        const completedItems = orderDiv.querySelectorAll('.line-item.completed');
        const createdTimeElement = orderDiv.querySelector('.created-time');
        if (items.length === completedItems.length) {
            orderDiv.classList.add('completed');
            createdTimeElement.textContent = 'Completed';
        } else {
            orderDiv.classList.remove('completed');
            createdTimeElement.textContent = `Created: ${getElapsedTime(orderDiv.dataset.createdTime)}`;
        }
    }

        function completeAllOrders() {
            const orders = document.querySelectorAll('.order');
            orders.forEach(order => {
                const items = order.querySelectorAll('.line-item');
                items.forEach(item => {
                    item.classList.add('completed');
                    const orderId = order.id.split('-')[1];
                    const itemId = item.getAttribute('onclick').split("'")[3];
                    completedOrderItems[orderId].add(itemId);
                    const itemsContainer = order.querySelector('.items-container');
                    itemsContainer.appendChild(item); // Move to the bottom

                    // Update server with the new state
                    fetch('/api/completed_orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ order_id: orderId, item_id: itemId, completed: true })
                    }).catch(error => console.error('Error updating completed order:', error));
                });
                order.classList.add('completed');
                const createdTimeElement = order.querySelector('.created-time');
                createdTimeElement.textContent = 'Created: Completed';
            });
        }

        function toggleCompletedOrders() {
            showCompleted = !showCompleted; // Toggle the state
            applyShowCompletedState();
        }

        function applyShowCompletedState() {
            const orders = document.querySelectorAll('.order');
            orders.forEach(order => {
                if (order.classList.contains('completed')) {
                    order.style.display = showCompleted ? 'block' : 'none';
                }
            });
            const button = document.querySelector('button[onclick="toggleCompletedOrders()"]');
            button.textContent = showCompleted ? 'Hide Completed Orders' : 'Show Completed Orders';
        }

        function updateElapsedTime() {
            const orders = document.querySelectorAll('.order');
            orders.forEach(order => {
                const createdTimeElement = order.querySelector('.created-time');
                if (!order.classList.contains('completed')) {
                    createdTimeElement.textContent = `Created: ${getElapsedTime(order.dataset.createdTime)}`;
                }
            });
        }

        // Fetch completed orders and then fetch orders every 10 seconds
        setInterval(fetchOrders, 10000);

        // Update elapsed time every second
        setInterval(updateElapsedTime, 1000);

        // Initial fetch
        fetchOrders();
    </script>
</body>
</html>